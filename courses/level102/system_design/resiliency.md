一個具備彈性的系統，能夠在逆境中持續運作。對於我們的應用程式而言，可能會有許多失效事件發生視為逆境。可能會有網路層級的失效導致整個資料中心癱瘓，也可能是機櫃層級或伺服器層級的問題，或者雲端供應商出狀況。我們也可能會遇到容量不足，或者因為錯誤的程式碼推送導致系統故障。我們將討論一些此類問題，並了解如何設計系統，繞過這些問題。在某些情況下，可能無法找到變通方法，但了解系統穩定性可能的脆弱點仍然很有價值。

彈性架構利用如優雅降級、配額限制、逾時與斷路器等系統設計模式。讓我們在此章節探討其中幾種。

## 配額限制

系統可能有某些元件或端點會被多個元件和端點使用。重要的是要有機制防止某個消費者或客戶端壓垮系統。配額限制是一種方法 — 我們為每個元件分配一個特定配額，指定每單位時間可送出的請求數。違反配額者會被警告或拒絕，視實作而定。這樣我們任何一個系統當機，就不會對其他系統造成拒絕服務。配額限制也有助於避免連鎖性失效。

## 優雅降級

當一個有多個相依元件的系統碰到其中一個元件失敗時，能夠優雅地降級至最小可用功能，比完全停擺要好很多。例如，假設我們應用程式有一個端點（服務 URL 或特定功能），負責從用戶上傳的圖片元資料中解析位置資訊，並向用戶提供位置標記建議。與其整個上傳過程失敗，不如直接跳過此功能，仍然讓用戶可以手動標記位置。相較於完全失效，優雅降級總是更好的選擇。

## 逾時控制

我們有時會呼叫其他服務或資源，如資料庫或 API 端點。從應用程式呼叫此類資源時，設定合理的逾時十分重要。資源不一定會全部請求都失敗，可能只是某些請求屬於高延遲尾端。合理的逾時設定，有助保持使用者體驗穩定 — 有時候失敗比持續長時間等待更好。

## 指數退避

當服務端點失敗時，重試是檢查是否暫時性失敗的方法之一，但如果重試也會失敗，無限重試毫無意義。在大規模系統中，重試可能與新請求競爭資源，造成系統飽和。為避免此情況，我們可使用指數退避，即在連續失敗的重試之間，逐漸增加等待時間，降低重試頻率。

## 斷路器

指數退避是一種處理重試風暴的方法，斷路器則是另一種。斷路器可以阻止失敗擴散至整個系統。否則，未被控制的失敗可能造成錯誤警報，增加偵測平均時間（MTTD）和修復平均時間（MTTR）。例如，當一個記憶體快取節點失效，導致請求超過快取的初始逾時後轉向資料庫，可能會使資料庫過載。如果沒有連接起快取節點失效與資料庫節點過載的關聯，可能會導致真實原因的 MTTD 增加，連帶影響 MTTR。

## 自我修復系統

傳統採用負載平衡、多實例架構的應用，當超過一定數量的實例停止回應（可能因故障或突然湧入大量請求，導致效能衰退）時會失效。自我修復系統能在此情況下增加更多實例，取代失效的實例。自動擴展也能應付突然的查詢量激增。如果應用程式架設於公共雲端，通常只要啟動更多[虛擬機器](https://azure.microsoft.com/en-in/overview/what-is-a-virtual-machine/)即可；若是自建資料中心，則需要更謹慎的容量規劃。不論擴增方式如何，單純增加容量可能仍不足夠，還需考慮其他潛在的失效模式，例如負載平衡層本身也可能需要擴充，以因應後端服務的增加。

## 持續部署與整合

設計良好的系統，還須考慮建置一個能盡可能模擬生產環境的測試環境（staging）。應該有方式在測試環境中重放生產流量，徹底測試對生產環境的變更。
