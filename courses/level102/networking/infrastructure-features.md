> *需要考慮的部分有，底層資料中心基礎設施是否支持 ToR 韌性，例如鏈路聚合（bond）、BGP、anycast 服務支持、負載平衡器、防火牆、服務品質 (QoS) 等功能。*

如前面章節所示，要大規模部署應用程式，基礎設施需要支援特定能力。本節將介紹不同可用選項及其適用性。

### ToR 連接

考量到大規模部署，這是最常見的故障點之一，有多種選擇可以用來連接伺服器與 ToR，以下將逐一說明：

#### 單一 ToR

這是所有選項中最簡單的，即伺服器的一張 NIC 連接至單一 ToR。此做法的優點是使用的交換器埠數量最少，讓資料中心網路能支持伺服器基礎架構的快速成長（註：不僅 ToR 埠使用效率高，上層交換架構中埠使用率也有效率）。缺點是，一旦 ToR、連結或 NIC 發生問題，伺服器將無法連線，此狀況對有狀態應用影響更大，因現有連線會突然中斷。

![圖形使用者介面，應用程式說明，可信度中等自動生成](./media/Single ToR.png)

圖 4：單一 ToR 設計

#### 雙 ToR

此選項中，每台伺服器連接至同一機櫃的兩台 ToR，可設定為主動/被動模式，藉此在 ToR、鏈路或 NIC 發生故障時提供韌性。韌性可在第 2 層或第 3 層實現。

##### 第 2 層

此時，兩條鏈路在伺服器端以 [bond](https://en.wikipedia.org/wiki/Link_aggregation)（鏈路聚合）方式綁定（一張 NIC 做為主動，另一個為被動）。在交換器端，這兩條鏈路則成為 [multi-chassis lag](https://en.wikipedia.org/wiki/Multi-chassis_link_aggregation_group) 的一部分（類似 bond，但分佈於多台交換器）。前提是兩台 ToR 必須在同一個第 2 層網域內。伺服器上的 IP 位址設定在 bond 介面上，交換器則在 SVI 上設定。

![自動生成的圖示說明](./media/Dual ToR.png)

註：此架構中，ToR 2 僅用於提供韌性。

圖 5：雙 ToR 第 2 層架構

##### 第 3 層

此種情況下，兩條鏈路各自設為獨立的第 3 層介面。透過啟用路由協定（如 BGP）來實現韌性，並將一條鏈路設為較高優先權。此時兩台 ToR 可獨立設定為第 3 層模式。伺服器需要一個虛擬位址，供服務綁定。

![自動生成的圖示說明](./media/Dual ToR BGP.png)

註：此架構中，ToR 2 僅用於提供韌性。

圖 6：雙 ToR 第 3 層架構

儘管雙 ToR 韌性較佳，缺點在於所用埠數倍增。由於 ToR 的接取埠數增加一倍，上層 Spine 層埠數也相應增加，這情況會一直級聯到更高層。

| 類型                | 單一 ToR          | 雙 ToR（第 2 層） | 雙 ToR（第 3 層）  |
|---------------------|------------------|------------------|-------------------|
| 韌性<sup>1</sup>    | 否<sup>2</sup>   | 是               | 是                |
| 埠使用率            | 1:1              | 1:2              | 1:2               |
| 佈線                | 較少             | 較多             | 較多              |
| 資料中心網路成本     | 低               | 高               | 高                 |
| ToR 功能需求         | 低               | 高               | 中                 |

<sup>1</sup> 指 ToR/鏈路/NIC 韌性

<sup>2</sup> 韌性可考慮在應用層面處理，作為替代方案。

除了上述選項外，應用程式可能還需要從基礎設施取得更多功能以實現大規模部署，以下為部分例子：

### Anycast

如前面部署大規模的章節所述，anycast 是一種讓服務分散在多個機櫃，且流量能流向各伺服器的方式。要達成此點，需要兩項支持：

1. ToR 與伺服器間的路由協定（用於宣告 anycast 位址）

2. 基礎設施能支持 ECMP（等價多路徑路由）負載平衡，用以分散流量至多機櫃。

### 負載平衡

與 Anycast 類似，另一種在伺服器間實現負載平衡（承載特定應用）的方式是使用負載平衡器。可採多種方式實現：

1. 硬體負載平衡器：負載平衡裝置位於流量路徑中，檢視封包的第 3 層和第 4 層資訊，決定要將連線導向哪些真實主機。正如在[擴展規模](https://linkedin.github.io/school-of-sre/level102/networking/scale/#load-balancer)一節介紹，可設置為兩種模式：

    - 單臂模式：負載平衡器僅處理對 VIP 的進入請求。伺服器回應直接發送給客戶端。可用兩種實作方式：

        * L2 DSR（Direct Server Return）：負載平衡器與真實伺服器處於同一 VLAN。收到請求後，負載平衡器辨識目標伺服器並修改乙太網幀的目的 MAC 位址，真實伺服器接獲後直接回應客戶端。

        * [L3 DSR](https://github.com/yahoo/l3dsr)：負載平衡器與伺服器不需在同一 VLAN（消除 STP 運作與廣播域過大等第 2 層複雜性）。負載平衡器收到請求後修改封包目的 IP，並設定封包的 DSCP 值至預定值（對應該 VIP）。真實伺服器根據 DSCP 值識別迴路位址（VIP 位址），回應同樣直接發送給客戶端。

    - 雙臂模式：負載平衡器處理進出流量。

2. DNS 負載平衡器：透過 DNS 伺服器監控真實伺服器健康狀態，並以適當方式解析網域，讓客戶端能連接該集群中不同伺服器。此部分詳見[擴展規模](https://linkedin.github.io/school-of-sre/level102/networking/scale/#dns-based-load-balancing)章節。

3. IPVS 負載平衡：IPVS 伺服器作為服務端點對外，接收請求後導向真實伺服器，並可設定健康檢查。

### NAT

網路位址轉換 (NAT) 用於那些需要連接至 Internet 但不想外露內部伺服器 NIC 位址的主機。例如代理伺服器、郵件伺服器等。此時內部位址會由防火牆轉譯為公開位址。

### QoS

服務品質 (Quality of Service) 是透過對不同封包提供差異化處理，如優先排隊或頻寬保留。在資料中心場景下，依據頻寬訂閱比，QoS 需求差異如下：

1. 1:1 頻寬訂閱比：伺服器到 ToR（該機櫃所有伺服器）頻寬應與 ToR 到 Spine 的頻寬相等，且上層也是如此。此時不會有鏈路塞車，因為頻寬恰當地完備，QoS 主要用於部分封包在轉發隊列中的優先處理。註：封包緩衝出現在不同速率埠間轉送，如 100Gbps 與 10Gbps 間。

2. 過度訂閱網路：此時並非所有層級皆維持頻寬訂閱比，例如，ToR 上行鏈路頻寬小於 ToR 到伺服器頻寬（即有過度訂閱比）。會有塞車風險，QoS 需求更大，可實現流量優先權與頻寬保留，針對特定流量類型。
