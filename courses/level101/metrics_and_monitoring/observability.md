##

# 可觀察性

工程師在談論建立可靠系統時，經常會使用「可觀察性（Observability）」這個詞。*可觀察性*源自控制理論，是指透過對系統外部輸出的了解，可以推斷系統內部狀態的能力。現今日常使用的服務基礎架構越來越複雜；單靠主動監控已不足以快速解決導致應用失效的問題。透過監控，你可以防止已知的過往失誤重複發生，但在複雜的服務架構下，許多未知因素可能導致潛在問題。為了解決這類情況，可以讓服務具備可觀察性。一個具備可觀察性的系統能夠提供對隱含失效模式的高度細粒度洞察。此外，具備可觀察性的系統還會提供大量關於內部運作的上下文資訊，從而促使你得以發現更深層的系統問題。

監控可協助偵測故障；而可觀察性則幫助更加深入了解系統。在工程師中間，常有一個誤解，認為監控和可觀察性是兩個不同的概念。實際上，可觀察性是監控的超集合，也就是說，監控提升了服務的可觀察性。可觀察性的目標不只是偵測問題，更在於了解問題在哪裡及其原因。除了指標（metrics）外，可觀察性還有另外兩大支柱：日誌（logs）和追蹤（traces），如圖9所示。雖然這三個組件並不會讓系統達到百分之百的可觀察性，但它們是提供更好系統理解的最重要且強大的組件。每個支柱都有其缺陷，詳情請參考[Three Pillars with Zero Answers](https://medium.com/lightstephq/three-pillars-with-zero-answers-2a98b36358b8)。

![三大可觀察性支柱](images/image7.png) <p align="center"> 圖9：三大可觀察性支柱 </p>

既然我們已經探討過指標，接下來來看看另外兩個支柱（日誌與追蹤）。

#### 日誌

日誌（通常稱作*事件*）是服務運行期間所執行活動的紀錄，並帶有相應的時間戳。指標提供系統退化的抽象資訊，而日誌提供導致這些退化的詳細原因。由應用程式和基礎設施元件產生的日誌，有助於有效理解系統行為，包含應用錯誤、異常及事件時間線等細節。日誌讓你能回溯時間，了解導致錯誤的事件。因此，檢查日誌是故障排查的重要步驟。

日誌處理包含將不同應用程式的日誌聚合，並將其發送至集中式儲存。搬移日誌到中央儲存能保存日誌，以防應用實例無法存取或因故障崩潰。當日誌集中保存後，可進一步分析日誌，從中擷取有意義的資訊。為了稽核和合規目的，在中央儲存中會保存一定期間的日誌。日誌分析器可以從日誌行中擷取有用資訊，如請求用戶資料、請求的 URL（功能）與回應標頭（如內容長度）及回應時間。這些資訊會根據屬性分組，並透過視覺化工具快速提供理解結果。

你可能會好奇這些日誌資訊有何助益。這些資料提供全貌，呈現所有相關實體的活動。例如，假設有人對一個 Web 應用發起拒絕服務攻擊（DoS）。透過日誌處理，你可以快速從訪問日誌中檢視最多的客戶端 IP，從而辨識攻擊來源。

同理，如果應用的某個功能在以特定請求參數值訪問時導致高錯誤率，日誌分析結果可以幫助你快速找出異常的參數值並採取後續措施。

![使用 ELK 堆疊進行日誌處理與分析](images/image4.jpg) 
<p align="center"> 圖10：使用 ELK 堆疊進行日誌處理與分析 </p>

圖10展示使用 ELK（Elasticsearch、Logstash、Kibana）的日誌處理平台，提供集中式日誌處理。Beats 是一組輕量級的資料發送器，可將日誌、稽核資料、網路資料等透過網路傳輸。本實例中，我們使用 Filebeat 作為日誌發送器，監控服務日誌檔並將資料送往 Logstash。Logstash 解析日誌並轉換資料，使其適合儲存於 Elasticsearch。轉換後的日誌資料存放在 Elasticsearch，並建立索引以便快速檢索。Kibana 則搜尋並顯示 Elasticsearch 中的日誌資料，並提供一組視覺化工具，圖形化呈現從日誌資料彙整的摘要。

儲存日誌成本不低。並且對伺服器上所有事件做廣泛日誌記錄，會造成高昂成本及佔用大量儲存空間。隨著服務數量增加，此成本會按比例上升。

#### 追蹤

到目前為止，我們已談過指標與日誌的重要性。指標提供系統的抽象概覽，日誌記錄了發生的事件。試想一個包含多個微服務的複雜分散式系統，一個使用者請求需要在系統內多個微服務間處理。指標和日誌能給你部分有關如何處理這些請求的資訊，但無法提供跨微服務的詳細資料，及其如何影響特定的客戶請求。如果一個下游微服務反應遲緩導致回應時間增加，你就需要詳細的可見性橫跨所有相關微服務，以辨識該微服務。這就需要請求追蹤機制。

追蹤由一系列 span 組成，每個 span 紀錄不同微服務為回應客戶請求所執行的事件。簡單來說，追蹤是從多個微服務跨不同物理主機收集而來的客戶請求服務日誌。每個 span 包含 span 的元資料（如 trace ID 與 span ID），以及上下文資訊，包含交易相關資料。

![URL 縮短服務請求的追蹤與 span](images/image3.jpg) 
<p align="center"> 圖11：URL 縮短服務請求的追蹤與 span </p>

圖11是先前我們在 Python 學習範例中的 [URL 縮短服務](https://dictcp.github.io/school-of-sre/level101/python_web/url-shorten-app/)追蹤的圖形展示。

與監控類似，追蹤基礎架構包含多個模組用於收集追蹤、儲存追蹤和存取追蹤。每個微服務執行追蹤庫，在背景收集追蹤，建立記憶體內批次並提交給追蹤後端。追蹤後端會正規化接收到的追蹤資料並存入持久儲存。追蹤資料來自多個微服務，因此追蹤儲存通常以遞增方式儲存並依照追蹤識別碼建立索引。此管理方式有助於重建追蹤資料並進行視覺化。圖12說明了分散式系統追蹤的構造。

![分散式追蹤架構](images/image5.jpg)
<p align="center"> 圖12：分散式追蹤架構 </p>

目前已有一套工具與框架可用來打造分散式追蹤解決方案。以下是一些熱門工具：

-   [OpenTelemetry](https://opentelemetry.io/)：雲原生軟體的可觀察性框架

-   [Jaeger](https://www.jaegertracing.io/)：開源分散式追蹤方案

-   [Zipkin](https://zipkin.io/)：開源分散式追蹤方案
