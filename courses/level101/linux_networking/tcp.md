# TCP

TCP 是一種與 UDP 類似的傳輸層協議，但它保證可靠性、流量控制及擁塞控制。  
TCP 透過使用序列號來保證可靠傳送。TCP 連線是由三次握手建立的。在這個過程中，客戶端會送出帶有初始序列號的 `SYN` 封包，伺服器收到後回傳一個帶有確認訊號的 `SYN` 封包與伺服器自己的序列號。當客戶端確認收到伺服器的 `SYN` 封包時，連線即建立。從此以後，每筆資料都被視為已被可靠成功傳送，一旦相關一方接收到該序列號的確認回應。

![三次握手](images/established.png)

```bash
# 若要了解握手過程，請在一個 bash 視窗執行封包擷取
tcpdump -S -i any port 80
# 在另一個 bash 視窗執行 curl
curl www.linkedin.com
```

![tcpdump-三次握手](images/pcap.png)


此圖中，客戶端發送一個 `SYN` 標誌 (用 [S] 表示)，序列號為 `1522264672`。伺服器收到後以帶有確認標誌 `ACK` (用 [.] 表示) 及自己的序列號標誌 `SYN` (用 [S] 表示) 回覆。伺服器使用序列號 `1063230400`，並確認它期待客戶端發送序列號 `1522264673`（客戶端序列號 + 1）。客戶端發送一個長度為零的確認封包給伺服器（伺服器序列號 + 1），此時連線正式建立。這就是所謂的三次握手。之後，客戶端發送了一個長度為 76 字節的封包，並將序列號增加 76。伺服器回應一個 170 字節的封包並關閉連線。這就是我們先前提到 HTTP/1.1 與 HTTP/1.0 的差異：在 HTTP/1.1 中，同一連線可以重複使用，減少了每次 HTTP 請求都需經過三次握手的額外負擔。若在客戶端與伺服器之間漏失封包，伺服器將不會回送 `ACK`，客戶端會重試傳送直到收到確認。這樣確保了可靠性。  
流量控制則是由每個區段中的 `WIN` 大小欄位實現。`WIN` 大小表示內核中可用於緩衝接收區段的 TCP 緩衝區長度。數值為 0 表示接收方的緩衝區已積壓許多資料，發送方必須暫停發送，讓接收方能夠跟上。這項流量控制可防止「接收方速度慢，發送方速度快」的問題。

TCP 也有擁塞控制機制，用於判斷在未收到 `ACK` 前可有多少封包在傳輸中。Linux 允許我們配置擁塞控制算法，這部分在此不做深入介紹。

當關閉連線時，客戶端或伺服器會呼叫 close 系統呼叫。假設是客戶端呼叫，客戶端內核會送出一個 `FIN` 封包給伺服器。伺服器內核在伺服器應用呼叫 close 前不會關閉連線。當伺服器應用呼叫 close 後，伺服器也會發送一個 `FIN` 封包，客戶端則進入 `TIME_WAIT` 狀態 2*MSS（約 120 秒），此期間該連線 socket 不可重複使用，以避免殘留舊封包導致 TCP 狀態異常。

![連線關閉](images/closed.png)

掌握了 TCP 與 HTTP 的知識之後，我們來看看 SRE 在工作中如何應用。

## SRE 角色中的應用
1. 利用負載平衡器擴展 HTTP 效能，需要對 TCP 與 HTTP 有深入了解。市面上有 [不同形式的負載平衡](https://blog.envoyproxy.io/introduction-to-modern-network-load-balancing-and-proxying-a57f6ff80236?gi=428394dbdcc3)，例如 L4、L7 負載平衡與直接伺服器回傳（Direct Server Return）等。根據效能與合規需求，可以選擇在負載平衡器或直接在伺服器端執行 HTTPS 解除負載。
2. 調整 `sysctl` 參數中的 `rmem` 和 `wmem`（如同我們對 UDP 的調整）可提升發送端與接收端的吞吐率。
3. `sysctl` 參數 `tcp_max_syn_backlog` 與 socket 變數 `somax_conn` 決定內核可完成三次握手但尚未由應用呼叫 accept 系統呼叫的同時連線數量。這在單線程應用中特別有用。當 backlog 滿了，新的連線會停留在 `SYN_RCVD` 狀態（用 `netstat` 能看到）直到應用呼叫 accept。
4. 如果短暫連線過多，應用可能會耗盡檔案描述符。深入瞭解 [tcp_reuse 與 tcp_recycle](http://lxr.linux.no/linux+v3.2.8/Documentation/networking/ip-sysctl.txt#L464) 參數可以幫助縮短在 `TIME_WAIT` 狀態的等待時間（但此方法風險也存在）。讓應用重用連線池而非大量建立新連線，也是改善策略之一。
5. 透過檢視指標與判斷瓶頸位置，是應用或是網路端問題。例如，若有太多 socket 處於 `CLOSE_WAIT` 狀態，問題多半在應用層；反覆重傳（retransmission）較可能是網路或作業系統棧的問題。掌握基礎原理可幫助我們更準確定位問題瓶頸。
