# IP 路由與資料連結層
我們將深入了解離開用戶端的封包如何抵達伺服器，反之亦然。當封包到達 IP 層時，傳輸層會填入來源埠與目標埠。IP/網路層會填入目標 IP（從 DNS 探得），然後在路由表上查找至目標 IP 的路徑。

```bash
# Linux `route -n` 指令顯示預設的路由表
route -n
```

```bash
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         172.17.0.1      0.0.0.0         UG    0      0        0 eth0
172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 eth0
```

此處，目的地 IP 與 Genmask 進行位元與運算（AND），若結果與路由表中的目的地欄位相同，則會選擇該閘道器（Gateway）及介面做路由。此例中 [linkedin.com](https://www.linkedin.com) 的 IP `108.174.10.10` 與 `255.255.255.0` 做 AND 運算後得到 `108.174.10.0`，並未與路由表中任一目的地欄位相符。接著 Linux 將目的地 IP 與 `0.0.0.0` 做 AND 運算，結果為 `0.0.0.0`，符合預設路由列。

路由表會依 Genmask 中設定為 1 的位元數多寡來排序處理，若無匹配時，Genmask 為 `0.0.0.0` 的列即為預設路由。
此步驟結束後，Linux 決定要透過介面 `eth0` 將封包送到下一跳路由器 `172.17.0.1`。封包的來源 IP 將設為 `eth0` 介面的 IP。
接著，要送到 `172.17.0.1`，Linux 必須找出該 IP 對應的 MAC 位址。MAC 位址從內部 ARP 快取查得，該快取存有 IP 位址與 MAC 位址的對應關係。若快取未命中，Linux 會在內部網路廣播 ARP 請求，詢問誰擁有 `172.17.0.1`。擁有該 IP 的主機會發送 ARP 回應，核心（Kernel）將其快取，接著將封包發送給閘道器，封包中會將來源 MAC 設為 `eth0` 的 MAC 位址，目的 MAC 設為剛才取得的 `172.17.0.1` 的 MAC 位址。每一跳路由過程類似，直到封包送達實際伺服器。傳輸層與其以上層級的處理則只會在終端伺服器端時才執行，中間跳點只涉及 IP/網路層。

![上述說明的截圖](images/arp.gif)

路由表中看到一個特殊閘道器是 `0.0.0.0`。此閘道器代表不需要 Layer3（網路層）跳轉即可送出封包，代表來源與目的地在同一網路內。核心必須找出目的地的 MAC，並適當地填入來源與目的 MAC，然後將封包送出，使其在中間沒有任何網路層跳轉的情況下抵達目的地。

如同我們在其他章節跟隨的流程，接下來以 SRE 實務的角度完成本單元。

## SRE 角色的應用場景
1. 一般而言，路由表由 DHCP 自動配置，隨意變更並非良好作法。若有特別原因必須調整路由表，應只在非常必要時才採取此作法。
2. 更妥善理解錯誤訊息，例如 “No route to host”（找不到主機路由）錯誤可能代表目的主機的 MAC 位址找不到，也可能代表目的主機離線。
3. 偶爾查看 ARP 表能幫助確認是否發生 IP 位址衝突，即同一 IP 被錯誤指派給兩台主機，導致系統行為異常。
