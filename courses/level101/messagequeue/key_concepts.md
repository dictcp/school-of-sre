# 主要概念

讓我們看看談論消息系統時的一些主要概念


### 傳遞保證			

消息服務的一個重要方面是確保消息能傳送給預期的接收者。不同系統提供不同等級的傳遞保證，了解這些保證對於選擇適合您需求的消息服務很重要。

*   **最多一次傳遞（at-most-once-delivery）**  此保證確保消息最多傳送一次給預期接收者。換句話說，消息可能會遺失，但絕不會傳送超過一次。此方式適用於可以容忍消息遺失但不希望重複的場景。

*   **至少一次傳遞（at-least-once-delivery）** 依此保證，消息至少會傳送一次給預期接收者，但在失敗時可能會被多次傳送。此方式適用於不允許消息遺失，但接收者能管理重複消息的情況。

*   **恰好一次傳遞（exactly-once-delivery）** 此保證確保消息恰好傳送一次給預期接收者，既不遺失也不重複。這是最嚴格的傳遞保證，適合無法容忍消息遺失與重複的應用。然而，須注意，由於分散式系統的複雜性和潛在失敗，任何消息系統都很難甚至不可能完全保證恰好一次傳遞。

選擇合適的傳遞保證取決於您的應用具體需求。例如，在金融交易中，恰好一次傳遞保證對避免重複處理支付或遺漏交易至關重要；而在日誌監控系統中，最多一次傳遞即可減少系統負擔。


### 消息排序與並行處理

在分散式消息系統中，確保消息正確排序及併行處理是一大挑戰。以下策略有助於維持順序和確保並行：

* **嚴格排序**：某些情況下必須維護嚴格順序，例如處理金融交易。這可能需要額外負擔，如序列號、緩衝及消息重排序。

* **部分排序**：部分排序適用於只需對消息子集排序的情況。例如，特定群組或分區中的消息必須按序處理，但不同群組或分區間的消息可獨立處理。

* **無序處理**：在某些情境下，消息以任意順序處理皆可接受。此方法減少複雜度並提升並行度，從而改善整體系統效能。

維持排序且保證並行的策略：可透過依鍵分區消息、使用序列號和緩衝機制來保持排序，同時允許併行處理。對排序需求與並行性的權衡至關重要，以達最佳系統表現。


### 扇出 / 扇入
扇出（Fan Out）與扇入（Fan In）是消息系統中兩個重要概念，分別涉及消息在多個消費者間的分發與多個生產者消息的聚合。

#### 扇出
扇出是一種模式，將單一消息發送至多個消費者，確保每個消費者都收到消息副本。此模式可透過發布訂閱（Pub/Sub）機制實現，或在如 RabbitMQ 等消息代理中建立多個擁有獨特路由鍵的綁定。扇出適用於多個服務或應用需獨立處理同一消息的場景，如發送通知給多位訂閱者、資料庫間的資料複製等。

#### 扇入
扇入是一種模式，來自多個生產者的消息會聚合，然後由單一或多個消費者集中處理。可透過多個生產者將消息送至共用隊列，由消費者消費該隊列實現。扇入適用於需要集中處理或整合多源資料的情境，如彙總來自多個服務的日誌，或合併多個物聯網裝置的感測器數據。


### 毒丸消息與死信（Dead Letters）
在消息系統中，毒丸消息是指可能導致消息處理管線錯誤或崩潰的問題消息。為因應此類消息，消息服務通常使用死信隊列（Dead Letter Queues, DLQ）。

毒丸消息是指因格式錯誤、資料遺失或錯誤等原因無法處理的消息。當消費者遇到毒丸消息時，必須妥善處理以避免崩潰或陷入無限重試循環。

死信隊列（DLQ）是用於存放毒丸消息或無法成功處理消息的獨立隊列。問題消息並未直接丟棄，而是轉送至 DLQ，讓工程師分析並解決問題。

為有效處理毒丸消息，您可實作錯誤處理與監控，設定帶退避策略的重試機制，並使用 DLQ 進行後續分析和修復。定期監控 DLQ，辨識造成毒丸消息的模式，並在消息處理管線中獲得改進以避免未來問題。


### 消息模式

#### 點對點（基於隊列）
此模式中，消息由單一生產者發送給單一消費者，透過消息隊列完成。即使隊列有多個消費者監聽，消息僅會被一個消費者消費。此模式確保消息由單一消費者處理，適合需順序處理消息或指定消費者處理的場景。


#### 發布訂閱模式
發布訂閱模式中，生產者將消息發佈至主題（topic），多個消費者訂閱該主題以接收消息。此模式支持一對多通信，單一消息可同時傳送給多個消費者。非常適合事件驅動架構及需要即時更新或通知的應用。
